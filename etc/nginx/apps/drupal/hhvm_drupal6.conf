location / {

  ## Trying to access private files directly returns a 404.
  location ^~ /sites/default/files/private/ {
      internal;
  }
  ## Trying to access private files directly returns a 404.
  location ^~ /sites/default/private/ {
      internal;
  }

  ## Support for the file_force module
  ## http://drupal.org/project/file_force.
  location ^~ /system/files_force/ {
      ## Include the specific FastCGI configuration. This is for a
      ## FCGI backend like php-cgi or php-fpm.
      include apps/drupal/fastcgi_drupal.conf;
      fastcgi_pass hhvm_phpcgi;

      ## If proxying to apache comment the two lines above and
      ## uncomment the two lines below.
      #proxy_pass http://phpapache/index.php?q=$uri;
      #proxy_set_header Connection '';

      ## For not signaling a 404 in the error log whenever the
      ## system/files directory is accessed add the line below.
      ## Note that the 404 is the intended behavior.
      log_not_found off;
  }

  ## If accessing an image generated by Drupal 6 imagecache, serve it
  ## directly if available, if not relay the request to Drupal to (re)generate
  ## the image.
  location ~* /imagecache/ {
      ## Image hotlinking protection. If you want hotlinking
      ## protection for your images uncomment the following line.
      #include apps/drupal/hotlinking_protection.conf;

      access_log off;
      expires 30d;
      try_files $uri @drupal;
  }

  ## Advanced Aggregation module CSS
  ## support. http://drupal.org/project/advagg.
  location ^~ /sites/default/files/advagg_css/ {
      expires max;
      add_header ETag '';
      add_header Last-Modified 'Wed, 20 Jan 1988 04:20:42 GMT';
      add_header Accept-Ranges '';

      location ~* /sites/default/files/advagg_css/css[_[:alnum:]]+\.css$ {
          access_log off;
          try_files $uri @drupal;
      }
  }

  ## Advanced Aggregation module JS
  ## support. http://drupal.org/project/advagg.
  location ^~ /sites/default/files/advagg_js/ {
      expires max;
      add_header ETag '';
      add_header Last-Modified 'Wed, 20 Jan 1988 04:20:42 GMT';
      add_header Accept-Ranges '';

      location ~* /sites/default/files/advagg_js/js[_[:alnum:]]+\.js$ {
          access_log off;
          try_files $uri @drupal;
      }
  }

  ## All static files will be served directly.
  location ~* ^.+\.(?:css|cur|js|jpe?g|gif|htc|ico|png|html|xml|otf|ttf|eot|woff|svg)$ {
      access_log off;
      expires 30d;
      ## No need to bleed constant updates. Send the all shebang in one
      ## fell swoop.
      tcp_nodelay off;
      ## Set the OS file cache.
      open_file_cache max=3000 inactive=120s;
      open_file_cache_valid 45s;
      open_file_cache_min_uses 2;
      open_file_cache_errors off;
  }

  ## PDFs and powerpoint files handling.
  location ~* ^.+\.(?:pdf|pptx?)$ {
      expires 30d;
      ## No need to bleed constant updates. Send the all shebang in one
      ## fell swoop.
      tcp_nodelay off;
  }

  ## MP3 and Ogg/Vorbis files are served using AIO when supported. Your OS must support it.
  #location ^~ /sites/default/files/audio/mp3 {
  #    location ~* ^/sites/default/files/audio/mp3/.*\.mp3$ {
  #        directio 4k; # for XFS
  #        ## If you're using ext3 or similar uncomment the line below and comment the above.
  #        #directio 512; # for ext3 or similar (block alignments)
  #        tcp_nopush off;
  #        #aio on;
  #        output_buffers 1 2M;
  #    }
  #}

  #location ^~ /sites/default/files/audio/ogg {
  #    location ~* ^/sites/default/files/audio/ogg/.*\.ogg$ {
  #        directio 4k; # for XFS
  #        ## If you're using ext3 or similar uncomment the line below and comment the above.
  #        #directio 512; # for ext3 or similar (block alignments)
  #        tcp_nopush off;
  #        #aio on;
  #        output_buffers 1 2M;
  #    }
  #}

  ## Pseudo streaming of FLV files:
  ## http://wiki.nginx.org/HttpFlvStreamModule.
  ## If pseudo streaming isn't working, try to comment
  ## out in nginx.conf line with:
  ## add_header X-Frame-Options SAMEORIGIN;
  #location ^~ /sites/default/files/video/flv {
  #    location ~* ^/sites/default/files/video/flv/.*\.flv$ {
  #        flv;
  #    }
  #}

  ## Pseudo streaming of H264/AAC files. This requires an Nginx
  ## version greater or equal to 1.0.7 for the stable branch and
  ## greater or equal to 1.1.3 for the development branch.
  ## Cf. http://nginx.org/en/docs/http/ngx_http_mp4_module.html.
  #location ^~ /sites/default/files/video/mp4 { # videos
  #    location ~* ^/sites/default/files/video/mp4/.*\.(?:mp4|mov)$ {
  #        mp4;
  #        mp4_buffer_size 1M;
  #        mp4_max_buffer_size 5M;
  #    }
  #}

  #location ^~ /sites/default/files/audio/m4a { # audios
  #    location ~* ^/sites/default/files/audio/m4a/.*\.m4a$ {
  #        mp4;
  #        mp4_buffer_size 1M;
  #        mp4_max_buffer_size 5M;
  #    }
  #}

  ## Advanced Help module makes each module provided README available.
  location ^~ /help/ {
      location ~* ^/help/[^/]*/README\.txt$ {
          ## Include the specific FastCGI configuration. This is for a
          ## FCGI backend like php-cgi or php-fpm.
          include apps/drupal/fastcgi_drupal.conf;
          fastcgi_pass hhvm_phpcgi;

          ## If proxying to apache comment the two lines above and
          ## uncomment the two lines below.
          #proxy_pass http://phpapache/index.php?q=$uri;
          #proxy_set_header Connection '';
      }
  }

  ## Replicate the Apache <FilesMatch> directive of Drupal standard
  ## .htaccess. Disable access to any code files. Return a 404 to curtail
  ## information disclosure. Hide also the text files.
  location ~* ^(?:.+\.(?:htaccess|make|txt|engine|inc|info|install|module|profile|po|pot|sh|.*sql|test|theme|tpl(?:\.php)?|xtmpl)|code-style\.pl|/Entries.*|/Repository|/Root|/Tag|/Template)$ {
      return 404;
  }

  # This is cool because no php is touched for static content
  try_files $uri @drupal;
}

location @drupal {
  rewrite ^/(.*)$ /index.php?q=$1;
}

location ~ \.php$ {
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  #NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
  include fastcgi_params;
  include apps/drupal/fastcgi_drupal.conf;
  fastcgi_pass hhvm_phpcgi;
  include apps/drupal/microcache_fcgi.conf;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  fastcgi_param REDIRECT_STATUS 200;
}

## Disallow access to .bzr, .git, .hg, .svn, .cvs directories: return
## 404 as not to disclose information.
location ^~ /.bzr {
  return 404;
}

location ^~ /.git {
  return 404;
}

location ^~ /.hg {
  return 404;
}

location ^~ /.svn {
  return 404;
}

location ^~ /.cvs {
  return 404;
}

## Disallow access to patches directory.
location ^~ /patches {
  return 404;
}

## Disallow access to drush backup directory.
location ^~ /backup {
  return 404;
}


